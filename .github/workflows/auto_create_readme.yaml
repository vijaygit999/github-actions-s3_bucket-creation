name: Auto Generate README

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write   # needed to push changes

jobs:
  generate-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: false

      - name: Generate README.md
        run: |
          cat > README.md <<'EOF'
          # Terraform S3 Bucket with GitHub Actions CI/CD

          This project provisions an **S3 bucket** using Terraform and maintains remote state in:
          - **S3 backend** for state persistence
          - **DynamoDB table** for state locking

          ## ðŸš€ One-Time Setup

          ### 1. Create Backend Resources
          ```bash
          aws s3 mb s3://my-terraform-backend-bucket --region us-east-1
          aws dynamodb create-table \
            --table-name terraform-locks \
            --attribute-definitions AttributeName=LockID,AttributeType=S \
            --key-schema AttributeName=LockID,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --region us-east-1
          ```

          ### 2. Configure GitHub Secrets
          Add the following under **Settings > Secrets and variables > Actions**:
          - \`AWS_ACCESS_KEY_ID\`
          - \`AWS_SECRET_ACCESS_KEY\`
          - \`AWS_DEFAULT_REGION\` (e.g., us-east-1)

          ### 3. Run Workflow
          Push to \`main\` branch or trigger manually via the **Actions tab**.

          ## ðŸ›  How It Works
          - **backend.tf** â†’ Configures Terraform remote state in S3 with DynamoDB lock  
          - **main.tf** â†’ Creates an S3 bucket  
          - **GitHub Actions** â†’ Runs Terraform \`init â†’ validate â†’ plan â†’ apply\` automatically  
          EOF

      - name: Commit and Push README.md
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Auto-generate README.md"
          git push
